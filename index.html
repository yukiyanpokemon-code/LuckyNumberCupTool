<script>
    let nameMap = {};

    // ★ 並列数を制限する Promise 実行関数
    async function limitedParallel(urls, limit, onProgress) {
        let index = 0;
        let completed = 0;
        const total = urls.length;
        const results = new Array(total);

        async function worker() {
            while (index < total) {
                const i = index++;
                const url = urls[i];

                try {
                    const res = await fetch(url);
                    results[i] = await res.json();
                } catch (e) {
                    results[i] = null;
                }

                completed++;
                onProgress(completed, total);
            }
        }

        // limit 個の worker を同時に走らせる
        const workers = Array.from({ length: limit }, worker);
        await Promise.all(workers);

        return results;
    }

    // ★ 図鑑情報ロード（20並列 + 進捗率表示）
    async function loadJapaneseNames() {
        const btn = document.getElementById("search-btn");
        const loadingMsg = document.getElementById("loading");

        btn.disabled = true;
        loadingMsg.innerHTML = "図鑑情報取得中… 0%";

        try {
            // 1. 全 species 一括取得
            const listRes = await fetch("https://pokeapi.co/api/v2/pokemon-species?limit=2000");
            const listData = await listRes.json();

            const urls = listData.results.map(x => x.url);

            // 進捗表示
            const updateProgress = (done, total) => {
                const percent = Math.floor((done / total) * 100);
                loadingMsg.innerHTML = `図鑑情報取得中… ${percent}%`;
            };

            // 2. 制限付き並列（20個ずつ）
            const speciesData = await limitedParallel(urls, 20, updateProgress);

            // 3. 日本語名 → 英語名 対応表生成
            for (const data of speciesData) {
                if (!data) continue;
                const jp = data.names.find(n => n.language.name === "ja-Hrkt")?.name;
                const en = data.name;
                if (jp) nameMap[jp.toLowerCase()] = en;
            }

        } catch (e) {
            console.error(e);
            loadingMsg.innerHTML = "読み込み失敗しました";
        }

        loadingMsg.innerHTML = "";
        btn.disabled = false;
    }

    loadJapaneseNames();


    // ==============================================
    // 以下、あなたの元コードと変わりません
    // ==============================================
    function normalizeName(inputName) {
        if (!inputName) return null;
        const name = inputName.trim().toLowerCase();

        let jpMatch = Object.keys(nameMap).find(jp => jp.startsWith(name));
        if (jpMatch) return nameMap[jpMatch];

        let enList = Object.values(nameMap);
        let enMatch = enList.find(en => en.startsWith(name));
        if (enMatch) return enMatch;

        return name;
    }

    async function fetchDexNumber(name) {
        try {
            const apiName = normalizeName(name);
            if (!apiName) return null;

            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${apiName}`);
            if (!res.ok) return null;

            const data = await res.json();
            return data.id;
        } catch {
            return null;
        }
    }

    async function searchAll() {
        const results = document.getElementById("results");
        const digitCount = document.getElementById("digit-count");
        const warning = document.getElementById("warning");

        results.innerHTML = "検索中…";
        digitCount.innerHTML = "";
        warning.innerHTML = "";

        const inputs = [
            p1.value, p2.value, p3.value,
            p4.value, p5.value, p6.value
        ];

        let html = "";
        let allDigits = "";

        for (let i = 0; i < inputs.length; i++) {
            const name = inputs[i].trim();
            if (!name) continue;

            const dex = await fetchDexNumber(name);

            if (dex) {
                html += `<div class="result-item">${name} → 図鑑番号：${dex}</div>`;
                allDigits += dex.toString();
            } else {
                html += `<div class="result-item">${name} → 見つかりません</div>`;
            }
        }

        results.innerHTML = html || "入力がありません。";

        if (allDigits.length > 0) {
            const count = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};

            for (let ch of allDigits) count[ch]++;

            let countText = "<h3>数字の出現回数</h3>";
            for (let i = 0; i <= 9; i++) {
                countText += `${i}：${count[i]}回<br>`;
            }
            digitCount.innerHTML = countText;

            let alertDigits = [];
            for (let i = 0; i <= 9; i++) {
                if (count[i] >= 3) alertDigits.push(i);
            }

            if (alertDigits.length > 0) {
                warning.innerHTML = `⚠️ 数字「${alertDigits.join(", ")}」が3つ以上含まれています！`;
            }
        }
    }
</script>
