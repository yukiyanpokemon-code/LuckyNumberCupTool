<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ポケモン図鑑No検索（6体 + 数字カウント）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 650px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        input {
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            width: 95%;
        }
        button {
            padding: 10px;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }
        .result-item {
            font-size: 18px;
            margin: 10px 0;
            padding: 8px;
            background: #f4f4f4;
            border-radius: 6px;
        }
        #digit-count {
            margin-top: 20px;
            background: #eef;
            padding: 10px;
            border-radius: 6px;
        }
        #warning {
            margin-top: 10px;
            color: red;
            font-size: 20px;
            font-weight: bold;
        }
        #loading {
            margin-top: 15px;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>

<h2>ポケモン図鑑検索（最大6体）</h2>

<p>ポケモンの名前（日本語 or 英語）を最大6つ入力してください。</p>

<div id="inputs">
    <input id="p1" placeholder="ポケモン名1">
    <input id="p2" placeholder="ポケモン名2">
    <input id="p3" placeholder="ポケモン名3">
    <input id="p4" placeholder="ポケモン名4">
    <input id="p5" placeholder="ポケモン名5">
    <input id="p6" placeholder="ポケモン名6">
</div>

<button id="search-btn" onclick="searchAll()">検索</button>
<div id="loading"></div>

<div id="results"></div>
<div id="digit-count"></div>
<div id="warning"></div>

<script>
    let nameMap = {};
    const TOTAL = 1025;

    // --------------------------
    // ★ API まとめ取り + 高速化(20並列)
    // --------------------------
    async function fetchBatch(start, end) {
        const tasks = [];
        for (let id = start; id <= end; id++) {
            tasks.push(
                fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`)
                    .then(res => res.json())
                    .then(data => {
                        const jp = data.names.find(n => n.language.name === "ja-Hrkt")?.name;
                        const en = data.name;
                        if (jp) nameMap[jp.toLowerCase()] = en;
                    })
                    .catch(() => {})
            );
        }
        await Promise.all(tasks);
    }

    // --------------------------
    // ★ 進捗表示 + キャッシュ利用
    // --------------------------
    async function loadJapaneseNames() {
        const btn = document.getElementById("search-btn");
        const loadingMsg = document.getElementById("loading");

         キャッシュ存在時：即座に読み込み完了にする
        const cache = localStorage.getItem("nameMap");
        if (cache) {
            nameMap = JSON.parse(cache);
            loadingMsg.innerHTML = "日本語データをキャッシュから読み込みました。";
            setTimeout(() => loadingMsg.innerHTML = "", 800);
            return;
        }

        // 初回は API 取得
        btn.disabled = true;
        loadingMsg.innerHTML = "図鑑データ取得中… 0%";

        const batchSize = 20;
        let completed = 0;

        for (let start = 1; start <= TOTAL; start += batchSize) {
            const end = Math.min(start + batchSize - 1, TOTAL);
            await fetchBatch(start, end);

            // 進捗更新
            completed = end;
            const percent = Math.floor((completed / TOTAL) * 100);
            loadingMsg.innerHTML = `図鑑データ取得中… ${completed}/${TOTAL} 件（${percent}%）`;
        }

        // キャッシュ保存
        localStorage.setItem("nameMap", JSON.stringify(nameMap));

        // 完了表示
        loadingMsg.innerHTML = "読み込み完了！";
        setTimeout(() => loadingMsg.innerHTML = "", 800);

        btn.disabled = false;
    }
    loadJapaneseNames();


    // --------------------------
    // 名前正規化
    // --------------------------
    function normalizeName(inputName) {
        if (!inputName) return null;
        const name = inputName.trim().toLowerCase();

        let jpMatch = Object.keys(nameMap).find(jp => jp.startsWith(name));
        if (jpMatch) return nameMap[jpMatch];

        let enList = Object.values(nameMap);
        let enMatch = enList.find(en => en.startsWith(name));
        if (enMatch) return enMatch;

        return name;
    }

    // --------------------------
    // 図鑑番号取得
    // --------------------------
    async function fetchDexNumber(name) {
        try {
            const apiName = normalizeName(name);
            if (!apiName) return null;

            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${apiName}`);
            if (!res.ok) return null;

            const data = await res.json();
            return data.id;
        } catch {
            return null;
        }
    }

    // --------------------------
    // 6体検索
    // --------------------------
    async function searchAll() {
        const results = document.getElementById("results");
        const digitCount = document.getElementById("digit-count");
        const warning = document.getElementById("warning");

        results.innerHTML = "検索中…";
        digitCount.innerHTML = "";
        warning.innerHTML = "";

        const inputs = [p1.value, p2.value, p3.value, p4.value, p5.value, p6.value];

        let html = "";
        let allDigits = "";

        for (let name of inputs) {
            name = name.trim();
            if (!name) continue;

            const dex = await fetchDexNumber(name);

            if (dex) {
                html += `<div class="result-item">${name} → 図鑑番号：${dex}</div>`;
                allDigits += dex.toString();
            } else {
                html += `<div class="result-item">${name} → 見つかりません</div>`;
            }
        }

        results.innerHTML = html || "入力がありません。";

        if (allDigits.length > 0) {
            const count = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};

            for (let ch of allDigits) count[ch]++;

            let countText = "<h3>数字の出現回数</h3>";
            for (let i = 0; i <= 9; i++) {
                countText += `${i}：${count[i]}回<br>`;
            }
            digitCount.innerHTML = countText;

            let alertDigits = [];
            for (let i = 0; i <= 9; i++) {
                if (count[i] >= 3) alertDigits.push(i);
            }

            if (alertDigits.length > 0) {
                warning.innerHTML = `⚠️ 数字「${alertDigits.join(", ")}」が3つ以上含まれています！`;
            }
        }
    }
</script>

</body>
</html>
